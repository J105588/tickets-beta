<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監査ログダッシュボード - 全スプレッドシート対応</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary { background: #6f42c1; color: white; }
        .btn-primary:hover { background: #5a32a3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px 30px;
        }

        .panel {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            color: #495057;
        }

        .panel-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6f42c1;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .log-entry {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-operation {
            font-weight: bold;
            color: #6f42c1;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .log-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .log-detail {
            display: flex;
            flex-direction: column;
        }

        .log-detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .log-detail-value {
            color: #212529;
            font-size: 0.8rem;
            word-break: break-word;
        }

        .spreadsheet-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .spreadsheet-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .spreadsheet-id {
            font-weight: bold;
            color: #6f42c1;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .spreadsheet-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 30px;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 監査ログダッシュボード</h1>
            <p>全スプレッドシート対応 - 詳細監査ログ管理システム</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="spreadsheetSelect">スプレッドシート選択</label>
                <select id="spreadsheetSelect">
                    <option value="">すべてのスプレッドシート</option>
                </select>
            </div>

            <div class="control-group">
                <label for="operationFilter">操作フィルター</label>
                <select id="operationFilter">
                    <option value="">すべての操作</option>
                </select>
            </div>

            <div class="control-group">
                <label for="dateFrom">開始日</label>
                <input type="date" id="dateFrom">
            </div>

            <div class="control-group">
                <label for="dateTo">終了日</label>
                <input type="date" id="dateTo">
            </div>

            <div class="control-group">
                <button class="btn btn-primary" onclick="refreshData()">データ更新</button>
            </div>

            <div class="control-group">
                <button class="btn btn-success" onclick="exportData()">エクスポート</button>
            </div>

            <div class="control-group">
                <button class="btn btn-info" onclick="manualSync()">手動同期</button>
            </div>

            <div class="control-group">
                <button class="btn btn-warning" onclick="showConfig()">設定</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="panel">
                <div class="panel-header">📈 統計情報</div>
                <div class="panel-content" id="statsContainer">
                    <div class="loading">統計情報を読み込み中...</div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">📋 スプレッドシート一覧</div>
                <div class="panel-content" id="spreadsheetContainer">
                    <div class="loading">スプレッドシート情報を読み込み中...</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">📝 最新ログ (50件)</div>
            <div class="panel-content" id="logsContainer">
                <div class="loading">ログを読み込み中...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { auditManager } from './audit-manager.js';
        import { auditConfig } from './audit-config.js';

        let currentSpreadsheetId = '';
        let currentLogs = [];
        let spreadsheetList = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDashboard();
        });

        // ダッシュボード初期化
        async function initializeDashboard() {
            try {
                // スプレッドシート一覧を取得
                await loadSpreadsheetList();
                
                // データを読み込み
                await refreshData();
                
                // フィルターを設定
                setupFilters();
                
            } catch (error) {
                console.error('ダッシュボード初期化エラー:', error);
                showError('ダッシュボードの初期化に失敗しました: ' + error.message);
            }
        }

        // スプレッドシート一覧を読み込み
        async function loadSpreadsheetList() {
            try {
                // SpreadsheetIds.gsからスプレッドシート一覧を取得
                if (window.SEAT_SHEET_IDS) {
                    spreadsheetList = Object.entries(window.SEAT_SHEET_IDS)
                        .filter(([key, id]) => id && id !== 'YOUR_SHEET_ID_HERE')
                        .map(([key, id]) => ({ key, id }));
                } else {
                    // デフォルトのスプレッドシートIDを設定
                    spreadsheetList = [
                        { key: '見本演劇-1-A', id: '1-lBQMuwjs0YnOpSt3nI8jQmHyNOqUNHiP3i2xXMcbmA' },
                        { key: '見本演劇-1-B', id: '164pnCFDZKmrHlwU0J857NzxRHBeFgdKLzxCwM7DKZmo' }
                    ];
                }

                // スプレッドシート選択ボックスを更新
                const select = document.getElementById('spreadsheetSelect');
                select.innerHTML = '<option value="">すべてのスプレッドシート</option>';
                
                spreadsheetList.forEach(({ key, id }) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${key} (${id.substring(0, 20)}...)`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('スプレッドシート一覧読み込みエラー:', error);
            }
        }

        // データを更新
        async function refreshData() {
            try {
                const spreadsheetId = document.getElementById('spreadsheetSelect').value;
                currentSpreadsheetId = spreadsheetId;

                // 統計情報を更新
                await updateStats(spreadsheetId);
                
                // スプレッドシート一覧を更新
                await updateSpreadsheetList();
                
                // ログを更新
                await updateLogs(spreadsheetId);

            } catch (error) {
                console.error('データ更新エラー:', error);
                showError('データの更新に失敗しました: ' + error.message);
            }
        }

        // 統計情報を更新
        async function updateStats(spreadsheetId) {
            try {
                const container = document.getElementById('statsContainer');
                
                if (spreadsheetId) {
                    // 特定のスプレッドシートの統計
                    const result = await auditManager.getStatsFromSpreadsheet(spreadsheetId);
                    if (result.success) {
                        displayStats(result.stats, container);
                    } else {
                        container.innerHTML = '<div class="error">統計情報の取得に失敗しました: ' + result.message + '</div>';
                    }
                } else {
                    // 全体の統計
                    const stats = auditManager.getStats();
                    displayStats(stats, container);
                }

            } catch (error) {
                console.error('統計更新エラー:', error);
                document.getElementById('statsContainer').innerHTML = '<div class="error">統計情報の更新に失敗しました</div>';
            }
        }

        // 統計情報を表示
        function displayStats(stats, container) {
            const statsHtml = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label">総ログ数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.demoOperations}</div>
                        <div class="stat-label">DEMO操作</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.normalOperations}</div>
                        <div class="stat-label">通常操作</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.errorCount || 0}</div>
                        <div class="stat-label">エラー数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(stats.byOperation || {}).length}</div>
                        <div class="stat-label">操作種類</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(stats.bySpreadsheet || {}).length}</div>
                        <div class="stat-label">スプレッドシート数</div>
                    </div>
                </div>
            `;
            container.innerHTML = statsHtml;
        }

        // スプレッドシート一覧を更新
        async function updateSpreadsheetList() {
            try {
                const container = document.getElementById('spreadsheetContainer');
                const spreadsheetHtml = spreadsheetList.map(({ key, id }) => `
                    <div class="spreadsheet-card">
                        <div class="spreadsheet-id">${key}</div>
                        <div class="spreadsheet-stats">
                            <div>ID: ${id.substring(0, 20)}...</div>
                            <div>状態: アクティブ</div>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `<div class="spreadsheet-list">${spreadsheetHtml}</div>`;

            } catch (error) {
                console.error('スプレッドシート一覧更新エラー:', error);
                document.getElementById('spreadsheetContainer').innerHTML = '<div class="error">スプレッドシート一覧の更新に失敗しました</div>';
            }
        }

        // ログを更新
        async function updateLogs(spreadsheetId) {
            try {
                const container = document.getElementById('logsContainer');
                
                if (spreadsheetId) {
                    // 特定のスプレッドシートのログ
                    const result = await auditManager.getLogsFromSpreadsheet(spreadsheetId, 50, 0);
                    if (result.success) {
                        displayLogs(result.logs, container);
                    } else {
                        container.innerHTML = '<div class="error">ログの取得に失敗しました: ' + result.message + '</div>';
                    }
                } else {
                    // 全体のログ
                    const logs = auditManager.getLogs().slice(0, 50);
                    displayLogs(logs, container);
                }

            } catch (error) {
                console.error('ログ更新エラー:', error);
                document.getElementById('logsContainer').innerHTML = '<div class="error">ログの更新に失敗しました</div>';
            }
        }

        // ログを表示
        function displayLogs(logs, container) {
            if (logs.length === 0) {
                container.innerHTML = '<div class="no-data">ログが見つかりません</div>';
                return;
            }

            const logsHtml = logs.map(log => `
                <div class="log-entry">
                    <div class="log-header">
                        <div class="log-operation">${getOperationText(log.operation)}</div>
                        <div class="log-timestamp">${formatTimestamp(log.timestamp)}</div>
                    </div>
                    <div class="log-details">
                        <div class="log-detail">
                            <div class="log-detail-label">スプレッドシートID</div>
                            <div class="log-detail-value">${log.spreadsheetId || '-'}</div>
                        </div>
                        <div class="log-detail">
                            <div class="log-detail-label">グループ</div>
                            <div class="log-detail-value">${log.group || '-'}</div>
                        </div>
                        <div class="log-detail">
                            <div class="log-detail-label">モード</div>
                            <div class="log-detail-value">${log.mode?.mode || '-'}</div>
                        </div>
                        <div class="log-detail">
                            <div class="log-detail-label">URL</div>
                            <div class="log-detail-value">${log.url || '-'}</div>
                        </div>
                    </div>
                    ${log.error ? `<div class="log-detail"><div class="log-detail-label">エラー</div><div class="log-detail-value" style="color: #dc3545;">${log.error}</div></div>` : ''}
                </div>
            `).join('');

            container.innerHTML = logsHtml;
        }

        // フィルターを設定
        function setupFilters() {
            const operationFilter = document.getElementById('operationFilter');
            const operations = [
                'reservation_start', 'reservation_success', 'reservation_failed',
                'checkin_start', 'checkin_success', 'mode_change_success',
                'walkin_issue_start', 'walkin_issue_success'
            ];

            operations.forEach(operation => {
                const option = document.createElement('option');
                option.value = operation;
                option.textContent = getOperationText(operation);
                operationFilter.appendChild(option);
            });
        }

        // 操作テキストを取得
        function getOperationText(operation) {
            const texts = {
                'reservation_start': '予約開始',
                'reservation_success': '予約成功',
                'reservation_failed': '予約失敗',
                'checkin_start': 'チェックイン開始',
                'checkin_success': 'チェックイン成功',
                'mode_change_success': 'モード変更成功',
                'walkin_issue_start': '当日券発行開始',
                'walkin_issue_success': '当日券発行成功'
            };
            return texts[operation] || operation;
        }

        // タイムスタンプをフォーマット
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 手動同期
        async function manualSync() {
            try {
                const result = await auditManager.manualSync();
                if (result.success) {
                    alert('同期が完了しました: ' + result.message);
                    await refreshData();
                } else {
                    alert('同期に失敗しました: ' + result.message);
                }
            } catch (error) {
                alert('同期エラー: ' + error.message);
            }
        }

        // データをエクスポート
        async function exportData() {
            try {
                const spreadsheetId = document.getElementById('spreadsheetSelect').value;
                
                if (spreadsheetId) {
                    const result = await auditManager.getLogsFromSpreadsheet(spreadsheetId, 10000, 0);
                    if (result.success) {
                        exportToFile(result.logs, `audit_logs_${spreadsheetId.substring(0, 10)}.json`);
                    } else {
                        alert('エクスポートに失敗しました: ' + result.message);
                    }
                } else {
                    const logs = auditManager.getLogs();
                    exportToFile(logs, 'audit_logs_all.json');
                }
            } catch (error) {
                alert('エクスポートエラー: ' + error.message);
            }
        }

        // ファイルにエクスポート
        function exportToFile(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 設定を表示
        function showConfig() {
            const config = auditManager.getConfig();
            const configText = `
=== 監査ログ設定 ===

有効: ${config.isEnabled}
自動同期: ${config.autoSync}
同期間隔: ${config.syncInterval / 1000}秒
最大ログ数: ${config.maxLogs}
同期待ちログ: ${config.pendingLogs}件
最終同期: ${config.lastSyncTime ? new Date(config.lastSyncTime).toLocaleString('ja-JP') : '未実行'}
            `;
            alert(configText);
        }

        // エラーを表示
        function showError(message) {
            const container = document.getElementById('logsContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // グローバル関数として公開
        window.refreshData = refreshData;
        window.exportData = exportData;
        window.manualSync = manualSync;
        window.showConfig = showConfig;
    </script>
</body>
</html>
