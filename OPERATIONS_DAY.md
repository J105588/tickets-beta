# チケット管理システム 完全理解マニュアル

## 📋 目次
1. [システム全体概要](#1-システム全体概要)
2. [アーキテクチャ詳細](#2-アーキテクチャ詳細)
3. [役割別クイックガイド](#3-役割別クイックガイド)
4. [開演30分前チェックリスト（必須）](#4-開演30分前チェックリスト必須)
5. [基本の流れと画面の見方](#5-基本の流れと画面の見方)
6. [モード別の使い方](#6-モード別の使い方)
7. [オフライン同期システムの仕組み](#7-オフライン同期システムの仕組み)
8. [座席データの構造と管理](#8-座席データの構造と管理)
9. [当日券発行の詳細ロジック](#9-当日券発行の詳細ロジック)
10. [認証・セキュリティシステム](#10-認証セキュリティシステム)
11. [エラー対応（困ったとき早見表）](#11-エラー対応困ったとき早見表)
12. [緊急時の対応](#12-緊急時の対応)
13. [システムの技術仕様](#13-システムの技術仕様)
14. [よくある質問（FAQ）](#14-よくある質問faq)
15. [用語完全辞典](#15-用語完全辞典)

---

## 1. システム全体概要

### 🎯 システムの目的
このチケット管理システムは、文化祭やイベントでの座席予約・チェックイン・当日券発行を管理するWebアプリケーションです。インターネット接続が不安定でも動作し、オフライン時でも全機能が利用できる堅牢なシステムです。

### 🏗️ システムの特徴
- **完全オフライン対応**: ネットワーク断絶時でも全機能が利用可能
- **リアルタイム同期**: オンライン復帰時に自動でデータを同期
- **4つの動作モード**: 通常・管理者・当日券・最高管理者モード
- **堅牢なエラーハンドリング**: 最大3回の自動リトライ機能
- **直感的なUI**: 色分けによる視覚的な座席状態表示

### 🔄 主要機能
1. **座席予約**: 一般ユーザーによる空席の予約
2. **チェックイン**: 予約済み座席の入場処理
3. **当日券発行**: 空席の自動割当と発行
4. **座席データ編集**: 最高管理者による直接編集
5. **オフライン同期**: 操作の自動保存と同期

---

## 2. アーキテクチャ詳細

### 🏛️ システム構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド   │    │    通信層        │    │   バックエンド    │
│                │    │                │    │                │
│ • HTML/CSS/JS  │◄──►│ • JSONP API    │◄──►│ • Google Apps  │
│ • OfflineSyncV2│    │ • オフライン委譲  │    │   Script (GAS)  │
│ • Service Worker│    │ • 自動同期      │    │ • API ルーター   │
│ • Local Storage│    │ • エラーハンドリング│    │ • ビジネスロジック│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
                                                ┌─────────────────┐
                                                │   データストア    │
                                                │                │
                                                │ • Google       │
                                                │   Spreadsheet  │
                                                │ • 座席データ     │
                                                │ • ログデータ     │
                                                └─────────────────┘
```

### 📱 フロントエンド詳細
- **HTML**: ページ構造（index.html, seats.html, walkin.html等）
- **CSS**: スタイル定義（色分け、アニメーション、レスポンシブ対応）
- **JavaScript**: 動作ロジック（ES6 Modules使用）
- **OfflineSyncV2**: オフライン同期システム（v2.0）
- **Service Worker**: 静的資産のキャッシュ
- **Local Storage**: 操作キューとキャッシュの永続化

### 🔧 バックエンド詳細
- **Google Apps Script**: サーバーサイド処理
- **API ルーター**: doGet/doPostによるJSONP通信
- **ビジネスロジック**: 座席管理、予約、チェックイン、当日券発行
- **認証システム**: モード別パスワード認証
- **ロック機能**: 同時アクセス制御

### 💾 データストア詳細
- **Google Spreadsheet**: メインデータベース
- **列構成**: A列（行）、B列（列番号）、C列（ステータス）、D列（予約名）、E列（チェックイン）
- **座席ID**: 行+列番号（例：A1, B2, E6）
- **ログ機能**: 操作履歴の記録

---

## 3. 役割別クイックガイド

### 一般受付（予約対応：通常モード）
**操作**: 緑の席をクリック → 「この席で予約する」 → 赤色になったらOK。

**ポイント**: 自動更新は約30秒おき。エラー時は「更新」ボタンを押す。

**よく使う声かけ**:
- 「空いているお席は緑色で表示されています」
- 「こちらのお席でよろしいですか？」
- 「予約が反映されるまで少しお待ちください」

**注意**: 今回の運用ではこの機能は使用しません。

---

### 受付スタッフ（チェックイン：管理者モード）
**準備**: サイドバー「≡」→「モード変更」→「管理者モード」→ パスワード入力（※この操作は演劇祭実行委員が行います）

**操作**:
1. 赤色（予約済）または黄色（確保）の席を選択（複数選択可）
2. 「選択した座席をチェックイン」ボタンを押す

**台本（例）**:
- （お客様を迎えて）「チケットをご提示ください。お連れ様とご一緒でしたら、まとめてご提示いただけますでしょうか？」
- （チケットを確認）「ありがとうございます。〇組、△△時からの公演ですね。お席は【座席番号】でございます。」
- （システムを操作）「ただいまチェックインいたします。」
- （操作完了後）「ありがとうございました。どうぞ、お楽しみください。」（客席誘導係へ案内）

---

### 当日券担当（当日券モード）
**準備**: サイドバー「≡」→「モード変更」→「当日券モード」→ パスワード入力

**操作**: 枚数（1〜6）を選び、「一緒」or「どこでもよい」を選択 → 「発行」ボタンを押す。

**台本（例）**:
- （お客様を迎えて）「当日券ですね。ご希望の組と時間帯を教えていただけますか？」
- （空き状況を確認し）「はい、何枚ご希望ですか？」
- 「お席は連番がよろしいですか？ それとも、離れたお席でも大丈夫でしょうか？」（※ここで「一緒」か「どこでも」を判断）
- （システムを操作し、席番号を発行）
- 「ありがとうございます。お席は【座席番号】になります。こちらの整理券に座席番号を記入してお渡ししますので、大切にお持ちください。」
- 「紛失しても再発行はいたしかねません」
- 「キャンセルは公演開始30分前までに本部までお問い合わせください」

---

### システム管理者（最高管理者モード）
**準備**: サイドバー「≡」→「モード変更」→「最高管理者モード」→ パスワード入力

**操作**: 席をクリック → 表示された編集画面で C/D/E 列の情報を編集 → 「確定」ボタンを押す。

**注意**: 誤操作防止のため、変更前に必ず内容を再確認してください。

---

## 2. 開演30分前チェックリスト（必須）

| チェック項目 | やること | OKの目印 |
|-------------|----------|----------|
| **ブラウザ準備** | Google Chrome（最新版）を開く。 | システムのURLが正常に開ける。 |
| **GAS疎通テスト** | 左上「≡」→「GAS疎通テスト」を実行。 | 「API疎通テスト: 成功」と表示される。 |
| **モード認証テスト** | 自分の役割に必要なモードでログイン。 | 画面上部にモード名が表示される。 |
| **当日券ページ確認** | 当日券モードで walkin.html にアクセス。 | 枚数選択と「一緒/どこでも」が選択できる。 |
| **緊急連絡の準備** | システム担当者の連絡先を手元に用意。<br>この場合は080-5030-7208<br>または、Teams | すぐに連絡できる状態にある。 |

---

## 3. 基本の流れと画面の見方

### 3-1. ページの移動:
- **組を選ぶ**: index.html
- **時間帯を選ぶ**: timeslot.html?group=1
- **座席を選ぶ**: seats.html?group=1&day=1&timeslot=A
- **当日券**: walkin.html

### 3-2. 画面の基本要素:
- **サイドバー**: 左上の「≡」で開閉。モード変更や同期など。
- **座席マップ**: クリックで座席を選択。
- **操作ボタン**: 画面下の「予約」「チェックイン」など。
- **状態インジケーター**: 左下の接続状態を示すアイコン（🟢/🟡/🔴/⚫）

### 3-3. 色の意味:
- 🟢 **緑**: 空席（予約可）
- 🟡 **黄**: 予約済
- 🔴 **赤**: チェックイン待ち
- ⚫ **グレー**: チェックイン済
- 🔵 **青枠**: 選択中（管理者モード）
- 🔴 **濃い赤**: 編集選択中（最高管理者モード）

---

## 4. モード別の使い方
（※詳細は役割別クイックガイドを参照）

### 4-1. 通常モード（予約受付）
**やること**: 緑の席をクリック → 「この席で予約する」を押す。

**ポイント**: エラーが出たらページを「更新」して、別の席を案内する。

### 4-2. 管理者モード（チェックイン）
**やること**: 赤色/黄色の席をクリック（青枠になる）→「チェックイン」ボタンを押す。

**ポイント**: 複数のチケットをまとめてチェックインすると効率的。

### 4-3. 当日券モード（当日券の発行）
**やること**: 枚数と「一緒」or「どこでも」を選択 → 「当日券を発行する」を押す。

**席の選び方ロジック**:
- **行の優先順**: A → B → C → D → E
- **番号の優先順**: 小さい番号から（1 → 2 → 3…）
- 「一緒」は同一行の連番、「どこでも」は空いている席から順番に確保。

### 4-4. 最高管理者モード（座席データ編集）
**やること**: 編集したい席をクリック → 表示された画面で情報を編集 → 「確定」を押す。

**編集できる内容**:
- **C列**: ステータス（空／確保／予約済／チェックイン済など）
- **D列**: 予約名やメモ
- **E列**: チェックイン状況（済 or 空白）

**注意**: 変更は慎重に。特にステータス変更は影響が大きいので、よく確認してから確定すること。

---

## 7. オフライン同期システムの仕組み

### 🔄 オフライン同期システム v2.0 の詳細

#### システム概要
オフライン同期システム v2.0は、ネットワーク接続が不安定な環境でも確実に操作を実行し、オンライン復帰時に自動でサーバーに同期する高度なシステムです。

#### 主要コンポーネント
1. **OfflineOperationManager**: オフライン操作の管理クラス
2. **操作キュー**: オフライン中の操作を順序付きで保存
3. **ローカルキャッシュ**: 座席データの一時保存
4. **自動同期**: オンライン復帰時の自動処理
5. **競合解決**: データ競合の自動解決

#### 同期設定（OFFLINE_CONFIG）
```javascript
{
  SYNC_INTERVAL_MS: 15000,        // 15秒間隔で同期
  MAX_RETRY_COUNT: 3,             // 最大3回リトライ
  RETRY_DELAY_MS: 5000,           // リトライ間隔5秒
  MAX_QUEUE_SIZE: 1000,            // 最大1000件の操作をキュー
  SYNC_TIMEOUT_MS: 30000,          // 同期タイムアウト30秒
  BACKGROUND_SYNC_INTERVAL: 15000, // バックグラウンド同期15秒
  CACHE_EXPIRY_MS: 300000         // キャッシュ有効期限5分
}
```

#### 操作タイプと優先度
```javascript
const OPERATION_TYPES = {
  RESERVE_SEATS: 'reserveSeats',                    // 優先度1（最高）
  CHECK_IN_SEATS: 'checkInMultipleSeats',          // 優先度2
  UPDATE_SEAT_DATA: 'updateSeatData',              // 優先度3
  ASSIGN_WALKIN: 'assignWalkInSeats',              // 優先度4
  ASSIGN_WALKIN_CONSECUTIVE: 'assignWalkInConsecutiveSeats' // 優先度4
};
```

#### 同期フロー
1. **オフライン検知**: ネットワーク断絶を検知
2. **ローカル処理**: 操作をローカルで実行
3. **キュー追加**: 操作をキューに保存
4. **オンライン復帰**: 接続復旧を検知
5. **自動同期**: キューから操作を順次実行
6. **競合解決**: データ競合を自動解決
7. **完了通知**: 同期完了をユーザーに通知

#### 状態インジケーター
- 🟢 **オンライン**: 正常にサーバーと通信中
- 🟡 **同期中**: オフライン操作をサーバーに送信中
- 🔴 **オフライン**: インターネット接続なし（一部操作は可能）
- ⚫ **エラー**: 通信エラーが発生

#### ローカルストレージの使用
```javascript
const STORAGE_KEYS = {
  OPERATION_QUEUE: 'offlineOperationQueue_v2',     // 操作キュー
  OPERATION_LOG: 'offlineOperationLog_v2',         // 操作ログ
  CACHE_DATA: 'offlineCacheData_v2',               // キャッシュデータ
  SYNC_STATE: 'offlineSyncState_v2',               // 同期状態
  CONFLICT_RESOLUTION: 'offlineConflictResolution_v2' // 競合解決
};
```

---

## 8. 座席データの構造と管理

### 📊 スプレッドシートの詳細構造

#### 列構成
| 列 | 内容 | 例 | 説明 |
|----|------|----|----|
| **A列** | 行ラベル | A, B, C, D, E | 座席の行（A〜E） |
| **B列** | 列番号 | 1, 2, 3, ..., 12 | 座席の列番号（E行は1〜6） |
| **C列** | ステータス | 空, 確保, 予約済 | 座席の状態 |
| **D列** | 予約名 | 田中太郎, 当日券_2025/09/05 14:30:00 | 予約者名または備考 |
| **E列** | チェックイン | 済, (空白) | チェックイン状態 |

#### 座席IDの生成ルール
- **形式**: 行ラベル + 列番号
- **例**: A1, A2, B1, B2, ..., E6
- **E行の制限**: E行は1〜6列のみ（他の行は1〜12列）

#### ステータスの詳細
- **空**: 予約可能な状態
- **確保**: 仮確保された状態（一時的な予約）
- **予約済**: 正式に予約された状態
- **チェックイン待ち**: チェックイン待機中の状態
- **チェックイン済**: チェックイン完了の状態

#### データの整合性管理
1. **ロック機能**: 同時アクセスを防止
2. **バリデーション**: 座席IDの有効性チェック
3. **トランザクション**: 複数座席の一括処理
4. **ログ機能**: 操作履歴の記録

---

## 9. 当日券発行の詳細ロジック

### 🎫 当日券発行システムの仕組み

#### 発行方法の詳細

**1. 一緒（同一行の連続席で確保）**
- **適用場面**: グループでの来場時
- **動作**: 指定枚数を同じ行で連続した席として確保
- **制限**: 行をまたぐ並びは不可
- **アルゴリズム**:
  1. A行 → B行 → C行 → D行 → E行の順で探索
  2. 各行内で1番 → 2番 → 3番...の順で探索
  3. 連続する空席を探す
  4. 最初に見つかった連続席を確保

**2. どこでもよい（ランダム）**
- **適用場面**: 個別での来場時
- **動作**: 空席から順番に確保
- **制限**: 連続性は問わない
- **アルゴリズム**:
  1. A行 → B行 → C行 → D行 → E行の順で探索
  2. 各行内で1番 → 2番 → 3番...の順で探索
  3. 空席から順番に確保

#### オンライン/オフライン同一の席選定ロジック
```javascript
// 行の優先順序
const rowOrder = ['A', 'B', 'C', 'D', 'E'];

// 各行の最大列数
const rowMaxCols = { A: 12, B: 12, C: 12, D: 12, E: 6 };

// 座席の探索順序
for (const row of rowOrder) {
  const maxCol = rowMaxCols[row];
  for (let col = 1; col <= maxCol; col++) {
    const seatId = `${row}${col}`;
    // 空席チェックと割当処理
  }
}
```

#### オフライン時の当日券発行
1. **ローカル処理**: キャッシュされた座席データで発行
2. **座席表示**: 実際の座席番号を表示
3. **キュー保存**: 操作をキューに保存
4. **自動同期**: オンライン復帰時にサーバーに反映
5. **重複防止**: ローカルで予約した座席をそのまま当日券として登録

#### エラーハンドリング
- **空席不足**: 枚数を減らすか「どこでも」に変更
- **連続席不足**: 別の時間帯を案内
- **システムエラー**: オフライン機能で継続

---

## 10. 認証・セキュリティシステム

### 🔐 認証システムの詳細

#### モード別認証
| モード | パスワード | 権限 | 認証方法 |
|--------|------------|------|----------|
| **通常モード** | 不要 | 座席予約のみ | 認証不要 |
| **管理者モード** | ADMIN_PASSWORD | チェックイン、座席名表示 | GAS認証 |
| **当日券モード** | WALKIN_PASSWORD | 当日券発行 | GAS認証 |
| **最高管理者モード** | SUPERADMIN_PASSWORD | 全権限、座席データ編集 | GAS認証 |

#### パスワード管理
- **保存場所**: Google Apps Scriptのスクリプトプロパティ
- **暗号化**: 平文で保存（運用環境では暗号化推奨）
- **設定方法**: `system-setting.gs`の`setupPasswords()`を実行
- **変更方法**: `changePassword()`関数を使用

#### 認証フロー
1. **パスワード入力**: ユーザーがパスワードを入力
2. **GAS認証**: `verifyModePassword()`でサーバー認証
3. **権限付与**: 認証成功時にモードを切り替え
4. **セッション管理**: localStorageにモード情報を保存
5. **ページリロード**: 権限を即座に反映

#### セキュリティ機能
- **APIレベル認証**: サーバー側で権限チェック
- **ページレベル制限**: 当日券ページは特定モードのみ
- **ボタンレベル制限**: 機能ボタンは権限に応じて表示
- **ロック機能**: 同時アクセス制御

---

---

## 11. エラー対応（困ったとき早見表）

### 🚨 重大エラー

**GAS疎通テスト失敗**:
- **原因**: インターネット接続がない、GASのURLが違う、など。
- **対応**: ①ネット接続を確認 → ②担当者に連絡 → ③代替URLを試す。

**オフライン同期エラー**:
- **原因**: データが破損している、ブラウザの調子が悪い、など。
- **対応**: ①サイドバーから「キャッシュクリア」→ ②ページを再読み込み → ③別のブラウザで試す。

### ⚠️ よくあるエラー

**「座席データの取得に失敗」**:
- **対応**: ページを再読み込みするか、手動更新ボタンを押す。解決しない場合は担当者へ連絡。

**「パスワード認証に失敗」**:
- **対応**: ①大文字/小文字、全角/半角が正しいか確認 → ②不要なスペースが入っていないか確認 → ③それでもダメなら担当者に連絡。

**「当日券の発行に失敗」**:
- **対応**: ①空席が不足していないか確認 → ②枚数を減らすか「どこでも」に変更して試す → ③別の時間帯を案内する。

**「すでに予約されています」**:
- **対応**: 画面を更新し、別の空席（緑色）を案内する。

---

## 12. 緊急時の対応

### 🚨 システム完全停止
1. **紙の受付に切り替え**: 手動での受付に移行
2. **システム担当者へ即時連絡**: 緊急対応を依頼
3. **復旧後の対応**: 手動受付分とデータを照合

### ⚡ 部分的な障害
- **ネット不安定時**: オフライン機能で運用を継続。インジケーターを注視
- **特定機能の不具合**: 別の方法で代替し（例：最高管理者モードで手動編集）、担当者へ連絡

### 📞 連絡時に伝える情報
- エラーメッセージの正確な内容
- 発生時刻
- 直前に行っていた操作
- どの機能が使えないか

---

## 13. システムの技術仕様

### 🔧 技術スタック
- **フロントエンド**: HTML5, CSS3, JavaScript (ES6 Modules)
- **バックエンド**: Google Apps Script (JavaScript)
- **データベース**: Google Spreadsheet
- **通信**: JSONP (JSON with Padding)
- **オフライン**: Service Worker, Local Storage
- **認証**: パスワードベース認証

### 📊 パフォーマンス仕様
- **同期間隔**: 15秒（バックグラウンド）
- **当日券同期**: 10秒（空席データ）
- **リトライ回数**: 最大3回
- **キャッシュ有効期限**: 5分
- **タイムアウト**: 30秒

### 🛡️ セキュリティ仕様
- **パスワード管理**: Google Apps Script プロパティ
- **API認証**: サーバー側権限チェック
- **ロック機能**: 同時アクセス制御
- **データ検証**: 座席ID有効性チェック

### 📱 ブラウザ対応
- **推奨**: Google Chrome（最新版）
- **対応**: Firefox, Safari, Edge
- **非対応**: Internet Explorer

---

## 14. よくある質問（FAQ）

### ❓ オフライン機能について
**Q. オフラインのまま操作して本当に大丈夫？**
A. はい、大丈夫です。操作内容は端末に記録され、ネットワーク復帰後に自動で同期されます。席番号もその場で確保されます。

**Q. オフライン時の操作はいつ同期されるの？**
A. ネットワーク復帰後、約15秒以内に自動で同期されます。手動同期も可能です。

### ❓ 当日券について
**Q. 当日券の「一緒」と「どこでも」の違いは？**
A. 「一緒」は同じ行の連番席を優先して探します。「どこでも」は空いている席ならどこでもOKとして割り当てます。

**Q. 当日券で連続席が取れない場合は？**
A. 枚数を減らすか「どこでも」に変更してください。別の時間帯を案内することも可能です。

### ❓ 予約・チェックインについて
**Q. 予約が他の人と被ったらどうなるの？**
A. 後から操作した方に「すでに予約されています」というエラーが表示されます。画面を更新して、別の席をご案内ください。

**Q. 間違えてチェックインしてしまった！**
A. 最高管理者モードでステータスを元に戻せます。落ち着いて担当者に連絡し、指示を仰いでください。

### ❓ システムについて
**Q. 画面が更新されない場合は？**
A. 自動更新は操作中は止まります。しばらく待つか、手動更新ボタンを押してください。

**Q. パスワードを忘れた場合は？**
A. システム担当者に連絡してください。パスワードの再設定が必要です。

---

## 15. 用語完全辞典

### 🔧 システム関連
- **サイドバー**: 画面左上の「≡」ボタンで開くメニュー
- **同期**: 端末（ブラウザ）での操作内容を、サーバー（Googleスプレッドシート）へ反映させること
- **ローカルキャッシュ**: データを高速に表示するため、お使いの端末に一時的に保存されるデータ
- **GAS (Google Apps Script)**: このシステムの頭脳部分。Googleのサービス上で動くプログラム
- **JSONP**: JSON with Padding。CORS制限を回避する通信方式
- **Service Worker**: ブラウザのバックグラウンドで動作するスクリプト。オフライン機能を提供

### 📊 データ関連
- **座席ID**: 行+列番号で構成される座席の識別子（例：A1, B2, E6）
- **ステータス**: 座席の状態（空、確保、予約済、チェックイン待ち、チェックイン済）
- **操作キュー**: オフライン時の操作を順序付きで保存する仕組み
- **競合解決**: 複数の操作が同じデータを変更しようとした際の自動解決機能

### 🔐 セキュリティ関連
- **モード認証**: 各モード（管理者、当日券、最高管理者）へのアクセス制御
- **API認証**: サーバー側での権限チェック
- **ロック機能**: 同時アクセスを防止する仕組み
- **スクリプトプロパティ**: Google Apps Scriptでパスワード等の機密情報を保存する場所

### 🎫 業務関連
- **当日券**: 当日に発行される座席券
- **チェックイン**: 予約済み座席の入場処理
- **連続席**: 同一行で番号が連続する座席
- **オフライン委譲**: ネットワークエラー時にローカル処理に切り替える機能

---

**最終更新**: 2025年9月5日  
**バージョン**: 2.0（オフライン同期システム対応）

このマニュアルで不明な点がある場合は、システム担当者に連絡してください。
