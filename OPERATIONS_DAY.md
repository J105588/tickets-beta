# チケット管理システム 当日運用マニュアル

## 📋 目次
- [システム概要](#システム概要)
- [開始前準備](#開始前準備)
- [基本操作](#基本操作)
- [各モードの詳細操作](#各モードの詳細操作)
- [エラー対応・トラブルシューティング](#エラー対応トラブルシューティング)
- [オフライン動作の詳細](#オフライン動作の詳細)
- [システム構造の理解](#システム構造の理解)
- [緊急時対応](#緊急時対応)
- [チェックリスト](#チェックリスト)

---

## システム概要

### 🎯 システムの目的
このシステムは文化祭やイベントでの座席予約・チェックイン・当日券発行を管理します。インターネット接続が不安定でも動作し、オフライン時でも全機能が利用できます。

### 🏗️ システム構成
- **フロントエンド**: ブラウザで動作するWebアプリケーション
- **バックエンド**: Google Apps Script（GAS）で動作するサーバー
- **データベース**: Google スプレッドシート
- **オフライン機能**: ローカルキャッシュと自動同期システム

### 🔄 動作モード
| モード | 権限 | 主な機能 | 認証 |
|--------|------|----------|------|
| **通常モード** | 一般ユーザー | 座席予約 | 不要 |
| **管理者モード** | 管理者 | チェックイン、座席名表示 | パスワード必要 |
| **当日券モード** | 当日券担当 | 当日券発行 | パスワード必要 |
| **最高管理者モード** | 最高管理者 | 座席データ編集、全権限 | パスワード必要 |

---

## 開始前準備

### ⏰ 開演30分前の準備（必須）

#### 1. ブラウザ環境の確認
- **推奨ブラウザ**: Google Chrome（最新版）
- **代替ブラウザ**: Firefox、Safari、Edge
- **避けるべき**: Internet Explorer（動作しない可能性）

#### 2. システムアクセス確認
1. システムURLを開く
2. 画面左上の「≡」メニューをクリック
3. 「GAS疎通テスト」を実行
   - ✅ **成功**: 「API疎通テスト: 成功」と表示
   - ❌ **失敗**: 以下の手順で確認
     - ネットワーク接続を確認
     - システム担当者に連絡
     - 代替URLがある場合は試行

#### 3. モード認証の確認
1. サイドバー > 「モード変更」をクリック
2. 必要なモードでログインできるか確認
   - 管理者モード: 管理者パスワード
   - 当日券モード: 当日券パスワード
   - 最高管理者モード: 最高管理者パスワード

#### 4. 当日券担当者の準備
- 当日券モードに切り替え
- 当日券ページ（walkin.html）にアクセスできるか確認
- 枚数選択（1〜6枚）が正常に動作するか確認

### 🚨 緊急時の準備
- **システム担当者の連絡先**を控えておく
- **代替の手動受付方法**を確認しておく
- **オフライン動作**の理解を深めておく

---

## 基本操作

### 🖱️ 画面遷移の流れ
```
組選択 → 時間帯選択 → 座席/当日券ページ
```

#### 詳細手順
1. **組選択**（index.html）
   - 対象の組をクリック
   - URL例: `timeslot.html?group=1`

2. **時間帯選択**（timeslot.html）
   - 対象の時間帯をクリック
   - URL例: `seats.html?group=1&day=1&timeslot=A`

3. **機能ページへ**
   - 通常/管理者/最高管理者: 座席ページ（seats.html）
   - 当日券: 当日券ページ（walkin.html）

### 📱 画面の基本要素
- **サイドバー**: 左上「≡」メニューで開閉
- **座席マップ**: 中央の座席表示エリア
- **操作ボタン**: 画面下部の各種ボタン
- **状態インジケーター**: 画面左下の接続状態表示

---

## 各モードの詳細操作

### 🟢 通常モード（予約受付）

#### 基本操作
1. 空席（緑色）をクリック
2. 「この席で予約する」ボタンをクリック
3. 予約完了（色が黄色に変化）

#### 表示される色の意味
- 🟢 **緑色**: 空席（予約可能）
- 🟡 **黄色**: 予約済み
- 🔴 **赤色**: チェックイン待ち
- ⚫ **グレー**: チェックイン済み
- 🔵 **青枠**: 選択中

#### 自動更新について
- **更新間隔**: 約30秒ごと
- **一時停止**: ユーザー操作中は自動更新が停止
- **手動更新**: 「更新」ボタンで即座に最新データを取得

#### よくあるエラーと対処法

**エラー1: 「この席は既に予約されています」**
- **原因**: 他のユーザーが先に予約
- **対処法**: 
  1. 画面を更新して最新状態を確認
  2. 他の空席を案内
  3. 別の時間帯を提案

**エラー2: 「ネットワークエラーが発生しました」**
- **原因**: インターネット接続の不安定
- **対処法**: 
  1. そのまま操作を続行（オフライン機能が動作）
  2. 接続復旧後に自動同期される
  3. 画面左下の接続状態を確認

### 🔵 管理者モード（チェックイン）

#### モード切り替え
1. サイドバー > 「モード変更」
2. 「管理者モード」を選択
3. 管理者パスワードを入力
4. 「モード変更」ボタンをクリック

#### チェックイン操作
1. チェックイン対象の席を複数選択（青枠で表示）
2. 「チェックイン」ボタンをクリック
3. 確認ダイアログで「はい」を選択
4. 完了（色が赤系に変化）

#### 複数席同時チェックイン
- **選択方法**: Ctrlキーを押しながら複数の席をクリック
- **一括操作**: 選択後「チェックイン」ボタンで一括処理
- **取り消し**: 選択を解除するには席を再クリック

#### よくあるエラーと対処法

**エラー1: 「パスワードが正しくありません」**
- **原因**: 間違ったパスワード入力
- **対処法**: 
  1. パスワードを再確認
  2. システム担当者に確認
  3. 大文字小文字、スペースに注意

**エラー2: 「選択された席がありません」**
- **原因**: 席を選択せずにチェックインボタンを押した
- **対処法**: 
  1. チェックイン対象の席を選択
  2. 青枠で表示されることを確認
  3. 「チェックイン」ボタンを押す

### 🎫 当日券モード（当日券発行）

#### モード切り替え
1. サイドバー > 「モード変更」
2. 「当日券モード」を選択
3. 当日券パスワードを入力
4. 「モード変更」ボタンをクリック

#### 当日券発行手順
1. **枚数選択**: 1〜6枚の範囲で選択
   - 「+」「-」ボタンで調整
   - 直接入力も可能

2. **発行方法選択**:
   - **一緒（同一行の連続席で確保）**: 同じ行で連続した席を確保
   - **どこでもよい**: 空席から順番に確保

3. **発行実行**: 「当日券を発行する」ボタンをクリック

4. **結果確認**: 割り当てられた席番号を表示

#### 席選定ロジック（重要）
- **行優先**: A行 → B行 → C行 → D行 → E行の順
- **番号昇順**: 各行内で1番 → 2番 → 3番...の順
- **連続席**: 同一行内で連番の席を確保
- **オンライン/オフライン同一**: 同じルールで動作

#### よくあるエラーと対処法

**エラー1: 「空席が不足しています」**
- **原因**: 指定枚数の連続席がない
- **対処法**: 
  1. 枚数を減らして再試行
  2. 「どこでもよい」に変更
  3. 別の時間帯を案内

**エラー2: 「当日券モードでアクセスしてください」**
- **原因**: 正しいモードでアクセスしていない
- **対処法**: 
  1. サイドバーで「当日券モード」に切り替え
  2. パスワードを正しく入力
  3. ページを再読み込み

**エラー3: 「処理中です。しばらくお待ちください」**
- **原因**: 前の処理が完了していない
- **対処法**: 
  1. 30秒程度待つ
  2. 画面を更新
  3. 再試行

### 🔴 最高管理者モード（座席データ編集）

#### モード切り替え
1. サイドバー > 「モード変更」
2. 「最高管理者モード」を選択
3. 最高管理者パスワードを入力
4. 「モード変更」ボタンをクリック

#### 座席編集操作
1. **座席選択**: 任意の座席をクリック（濃い赤色で表示）
2. **編集モーダル**: 自動で編集画面が開く（アニメーション付き）
3. **データ編集**:
   - **C列**: ステータス（空、確保、予約済など）
   - **D列**: 予約名・備考
   - **E列**: チェックイン状態・その他
4. **保存**: 「確定」ボタン → 確認ダイアログ「はい」

#### 編集可能な列の詳細
- **C列（ステータス）**: 
  - `空`: 予約可能
  - `確保`: 仮確保
  - `予約済`: 正式予約済み
  - `チェックイン待ち`: チェックイン待機中
  - `チェックイン済`: チェックイン完了

- **D列（予約名）**: 
  - 予約者の名前
  - 備考・連絡先
  - 当日券の場合は「当日券_日時」形式

- **E列（チェックイン）**: 
  - `済`: チェックイン完了
  - 空白: 未チェックイン

#### よくあるエラーと対処法

**エラー1: 「座席データの更新に失敗しました」**
- **原因**: スプレッドシートへの書き込みエラー
- **対処法**: 
  1. スプレッドシートの権限を確認
  2. システム担当者に連絡
  3. 一時的に手動でスプレッドシートを更新

**エラー2: 「編集モーダルが表示されません」**
- **原因**: JavaScriptエラーまたはモード認証の問題
- **対処法**: 
  1. ブラウザのコンソールでエラーを確認
  2. ページを再読み込み
  3. 最高管理者モードに再ログイン

---

## エラー対応・トラブルシューティング

### 🚨 重大なエラー

#### エラー1: 「GAS疎通テスト: 失敗」
**症状**: システムにアクセスできない
**原因**: 
- Google Apps Scriptの公開設定の問題
- ネットワーク接続の問題
- GASのデプロイURLの問題

**対処法**:
1. **即座の対応**:
   - システム担当者に連絡
   - 代替の手動受付方法に切り替え
   - オフライン機能を活用

2. **技術的対応**:
   - GASの公開設定を「全員（匿名含む）」に変更
   - 新しいデプロイURLを取得
   - ネットワーク接続を確認

#### エラー2: 「オフライン同期エラー」
**症状**: オフライン時の操作が同期されない
**原因**: 
- ローカルストレージの容量不足
- データの破損
- ブラウザの制限

**対処法**:
1. **即座の対応**:
   - ブラウザのキャッシュをクリア
   - ページを再読み込み
   - 別のブラウザで試行

2. **技術的対応**:
   - ローカルストレージをクリア
   - システム担当者に連絡
   - 手動でスプレッドシートを更新

### ⚠️ 一般的なエラー

#### エラー3: 「座席データの取得に失敗しました」
**症状**: 座席マップが表示されない
**原因**: 
- スプレッドシートの権限問題
- データの破損
- ネットワークの問題

**対処法**:
1. ページを再読み込み
2. 手動更新ボタンをクリック
3. システム担当者に連絡

#### エラー4: 「パスワード認証に失敗しました」
**症状**: モード変更ができない
**原因**: 
- 間違ったパスワード
- パスワードの設定漏れ
- 大文字小文字の違い

**対処法**:
1. パスワードを再確認
2. システム担当者に確認
3. パスワードの再設定を依頼

#### エラー5: 「当日券の発行に失敗しました」
**症状**: 当日券が発行できない
**原因**: 
- 空席の不足
- システムの一時的な問題
- データの不整合

**対処法**:
1. 枚数を減らして再試行
2. 「どこでもよい」に変更
3. 別の時間帯を案内

### 🔧 ブラウザ別の注意点

#### Google Chrome（推奨）
- 最も安定して動作
- オフライン機能が完全にサポート
- デバッグツールが充実

#### Firefox
- 基本的な機能は動作
- 一部の高度な機能で制限あり
- オフライン機能は動作

#### Safari
- 基本的な機能は動作
- 一部のJavaScript機能で制限
- オフライン機能は動作

#### Edge
- 基本的な機能は動作
- Chromeと同様の動作
- オフライン機能は動作

---

## オフライン動作の詳細

### 📡 接続状態の表示

#### インジケーターの意味
- 🟢 **オンライン**: 正常にサーバーと通信中
- 🟡 **同期中**: オフライン操作をサーバーに送信中
- 🔴 **オフライン**: インターネット接続なし
- ⚫ **エラー**: 通信エラーが発生

#### オフライン時の動作
1. **ローカル処理**: キャッシュされたデータで操作
2. **操作キュー**: オフライン中の操作を保存
3. **自動同期**: オンライン復帰時に自動で送信

### 🔄 同期の仕組み

#### バックグラウンド同期
- **間隔**: 約15秒ごと
- **内容**: 操作キューとキャッシュの更新
- **表示**: 画面左下に進捗表示

#### 当日券用空席同期
- **間隔**: 約10秒ごと
- **内容**: 当日券発行用の空席データ更新
- **目的**: リアルタイムな空席状況の把握

#### 同期エラーの対処
1. **自動リトライ**: 最大3回まで自動再試行
2. **手動同期**: サイドバーから手動で同期実行
3. **エラー報告**: システム担当者に連絡

### 💾 ローカルキャッシュの管理

#### キャッシュの内容
- 座席マップデータ
- 座席の状態情報
- 操作履歴
- 設定情報

#### キャッシュの有効期限
- **デフォルト**: 24時間
- **自動更新**: オンライン時に最新データで更新
- **手動クリア**: サイドバーから実行可能

#### キャッシュエラーの対処
1. **キャッシュクリア**: サイドバーから実行
2. **ページ再読み込み**: 最新データを取得
3. **ブラウザ再起動**: 完全なリセット

---

## システム構造の理解

### 🏗️ アーキテクチャ概要

#### フロントエンド（ブラウザ）
- **HTML**: ページの構造
- **CSS**: デザインとレイアウト
- **JavaScript**: 動作とロジック
- **Service Worker**: オフライン機能

#### バックエンド（Google Apps Script）
- **API ルーター**: リクエストの処理
- **ビジネスロジック**: 座席管理の処理
- **データベース**: スプレッドシートとの連携

#### データストア（Google スプレッドシート）
- **座席データ**: 各座席の状態
- **ログデータ**: 操作履歴
- **設定データ**: システム設定

### 🔄 データフロー

#### 通常の操作フロー
1. ユーザーがブラウザで操作
2. JavaScriptがAPIを呼び出し
3. Google Apps Scriptが処理
4. スプレッドシートを更新
5. 結果をブラウザに返却
6. 画面を更新

#### オフライン時のフロー
1. ユーザーがブラウザで操作
2. ローカルキャッシュで処理
3. 操作をキューに保存
4. オンライン復帰時に同期
5. サーバーに操作を送信
6. スプレッドシートを更新

### 📊 座席データの構造

#### スプレッドシートの列構成
- **A列**: 行ラベル（A〜E）
- **B列**: 列番号（1〜12、E行は1〜6）
- **C列**: ステータス（空、確保、予約済など）
- **D列**: 予約名（任意）
- **E列**: チェックイン（済のみ使用）

#### 座席IDの形式
- **形式**: 行 + 列番号
- **例**: A1, A2, B1, B2...
- **E行**: E1, E2, E3, E4, E5, E6

### 🔐 セキュリティの仕組み

#### パスワード認証
- **保存場所**: Google Apps Scriptのスクリプトプロパティ
- **暗号化**: 平文で保存（運用環境では暗号化推奨）
- **権限**: モード別に異なるパスワード

#### アクセス制御
- **ページレベル**: 当日券ページは特定モードのみ
- **ボタンレベル**: 機能ボタンは権限に応じて表示
- **APIレベル**: サーバー側で権限チェック

---

## 緊急時対応

### 🚨 システム完全停止時

#### 即座の対応
1. **手動受付に切り替え**: 紙ベースでの受付
2. **システム担当者に連絡**: 緊急対応を依頼
3. **代替手段の準備**: 別のシステムや方法を検討

#### 復旧後の対応
1. **データの整合性確認**: 手動受付分との照合
2. **システムの動作確認**: 全機能のテスト
3. **運用の再開**: 段階的な復旧

### ⚡ 部分的な障害時

#### ネットワーク不安定
1. **オフライン機能を活用**: ローカル処理で継続
2. **同期状況を監視**: 画面左下のインジケーター確認
3. **手動同期の実行**: サイドバーから実行

#### 特定機能の不具合
1. **代替機能の使用**: 他の方法で対応
2. **システム担当者に連絡**: 詳細な状況を報告
3. **一時的な回避策**: 手動での対応

### 📞 連絡先とエスカレーション

#### 連絡先の優先順位
1. **受付リーダー**: 現場の判断と指示
2. **システム担当者**: 技術的な問題の解決
3. **教員/主催責任者**: 重大な判断が必要な場合

#### 連絡時の情報
- **エラーメッセージ**: 画面に表示された内容
- **発生時刻**: エラーが発生した時間
- **操作内容**: エラーが発生した操作
- **影響範囲**: どの機能に影響があるか

---

## チェックリスト

### 🌅 開演前（30分前）

#### システム確認
- [ ] ブラウザが最新版である
- [ ] システムURLにアクセスできる
- [ ] GAS疎通テストが成功する
- [ ] 必要なモードにログインできる
- [ ] 座席マップが正常に表示される

#### 当日券担当者
- [ ] 当日券モードにログインできる
- [ ] 当日券ページにアクセスできる
- [ ] 枚数選択が正常に動作する
- [ ] 発行方法の選択ができる

#### 緊急時準備
- [ ] システム担当者の連絡先を確認
- [ ] 代替の手動受付方法を確認
- [ ] オフライン動作の理解を確認

### 🎭 開演中

#### 通常受付
- [ ] 空席の色が正しく表示されている
- [ ] 予約操作が正常に動作する
- [ ] 自動更新が動作している
- [ ] エラーメッセージがない

#### チェックイン
- [ ] 管理者モードにログインできる
- [ ] 複数席の選択ができる
- [ ] チェックイン操作が正常に動作する
- [ ] 色の変化が正しく表示される

#### 当日券発行
- [ ] 当日券モードにログインできる
- [ ] 枚数選択が正常に動作する
- [ ] 発行方法の選択ができる
- [ ] 席番号が正しく表示される

### 🌙 終了後

#### データ確認
- [ ] 全ての操作が同期されている
- [ ] 未処理の操作がない
- [ ] エラーログがない
- [ ] データの整合性が保たれている

#### システム終了
- [ ] ブラウザを閉じる
- [ ] ログアウト処理を実行
- [ ] システム担当者に終了を報告
- [ ] 次回の準備事項を確認

### 📊 日次レポート

#### 運用状況
- [ ] 予約件数の確認
- [ ] 当日券発行件数の確認
- [ ] チェックイン件数の確認
- [ ] エラー発生件数の確認

#### システム状況
- [ ] オフライン動作の回数
- [ ] 同期エラーの回数
- [ ] システム停止の回数
- [ ] 改善点の記録

---

## 付録

### 🎨 表示色の完全ガイド

#### 座席の状態色
- 🟢 **緑色**: 空席（予約可能）
- 🟡 **黄色**: 予約済み
- 🔴 **赤色**: チェックイン待ち
- ⚫ **グレー**: チェックイン済み
- 🔵 **青枠**: 選択中（管理者モード）
- 🔴 **濃い赤**: 編集選択中（最高管理者モード）

#### システム状態色
- 🟢 **緑**: オンライン（正常）
- 🟡 **黄**: 同期中
- 🔴 **赤**: オフライン
- ⚫ **黒**: エラー

### 📱 画面要素の説明

#### サイドバー
- **≡**: メニューボタン
- **モード変更**: 権限の切り替え
- **GAS疎通テスト**: システムの動作確認
- **同期状況**: オフライン操作の状況

#### 座席マップ
- **座席**: クリック可能な四角形
- **凡例**: 色の意味を表示
- **更新ボタン**: 手動でのデータ更新

#### 操作ボタン
- **予約**: 座席の予約
- **チェックイン**: 複数席の一括チェックイン
- **当日券**: 当日券の発行
- **編集**: 座席データの編集

### 🔧 技術的な詳細

#### オフライン同期の設定
- **同期間隔**: 15秒（バックグラウンド）
- **当日券同期**: 10秒（空席データ）
- **リトライ回数**: 最大3回
- **キャッシュ有効期限**: 24時間

#### ブラウザの要件
- **JavaScript**: 有効である必要
- **Local Storage**: 有効である必要
- **Service Worker**: サポートされている必要
- **Cookie**: 有効である必要

---

**最終更新**: 2025年9月5日  
**バージョン**: 2.0（オフライン同期システム対応）

このマニュアルで不明な点がある場合は、システム担当者に連絡してください。
